# 第3章 数据链路层

## 使用点对点信道的数据链路层

### 数据链路和帧

> 数据链路

**数据链路** 既包含 **物理线路** 也包含必要的 **通信协议**，将实现协议的软件和硬件加到链路上就构成了数据链路。

常用 **网络适配器**（既包括硬件也包括软件）来实现这些协议，一般适配器包括了数据链路层和物理层两层的功能。

> 帧
>
> **帧** 是点对点信道的数据链路层的 **协议数据单元**。网络层的协议数据单元是IP数据报，又称分组。

数据链路层将网络层交下来的数据构成帧发送到链路上，以及把接收到的帧里的数据取出并上交给网络层。

![三层关系](images/三层关系.png)

> 点对点信道的数据链路层在通信时的主要步骤：

1. 结点A的数据链路层把网络层交下来的IP数据报加上首部和尾部封装成帧。
2. 结点A把封装好的帧发送给结点B。
3. 结点B对接收到的帧进行差错检验，若无差错，从帧中提取出IP数据报上交给网络层，若有差错丢弃这个帧。

### 数据链路层的三个基本问题

#### 封装成帧

封装成帧：就是在一段数据前后分别 **添加首部和尾部**，确定帧的界限，然后就构成了一个帧

添加首部和尾部的作用：进行帧定界(确定帧的界限)；包含许多必要的 **控制信息**

**帧长**：帧的数据部分加上帧首部和帧尾部的长度

**最大传送单元** *MTU*：链路层协议规定的所能传送的帧的数据部分长度上限

帧格式如下图：

![帧格式](images/帧格式.png)

> **帧定界**
> 
> 方法：可用特殊的帧定界符，在 *ACSCII* 码中，用 *SOH* 表示帧的首部开始，*EOT* 表示帧的结束
>
> 作用：判断收到的帧是否完整，不完整则丢弃

#### 透明传输

**透明传输**：不管什么数据，都能完整无差错的通过这个数据链路层，数据链路层对数据没有妨碍，**数据链路层对数据时透明的**

透明传输中的问题：若数据中的某个字节的二进制代码恰好组成了帧界定符，就会出现错误

解决方法：**字节填充**，在控制字符和特殊字符前插入一个 **转义字符** *"ESC"*，**而真正的首部和尾部前不加**

![透明传输](images/透明传输.png)

#### 差错检测

> [!Warning]
> **比特差错**：在传输中可能会产生比特差错，1可能变0，0可能变1
>
> **误码率** *BER*：在一段时间，传输错误的比特占所有传输比特总数的比率，与信噪比有关

> **循环冗余校验** *(CRC)*

**原理**：在发送端，先把数据划分为组，假定每组k个比特，若传输一组数据M=101001(k=6)，在M后添加供差错检测用的n位冗余码后一起发送，共发送(k+n)位，接收方用收到的数据除P，若余数为0则表示没有差错

**冗余码计算方法**：在M后面添加n个0，得到（k+n）位的数除以选定好的除数p，得出商Q，余数R，将余数R作为冗余码，添加到M后

> [!tip]
> **例**：k=6，M=101001，设n=3，除数P=1101，被除数是101001000，计算后得到商Q=110100，余数R=001

**帧校验序列** *(FCS)*：为差错检验而添加的冗余码；就是计算后得到的余数R 

**生成多项式**：一种方便的表示循环冗余校验过程的方法

> [!tip]
> **例**：$P=1101\to P(X)=X^{3}+X^{2}+1$ (最高位对应 $x^{3}$，最低位对应 $x^{0}$)

**传输差错的分类**：
- **比特差错**：1变0，0变1
- **帧丢失**：丢失某个帧
- **帧重复**：某个帧收到多次
- **帧失序**：后发送的帧反而先到达接收端

**CRC的局限性**：只能实现 **无比特差错**，不能实现 **无传输差错**，只能判断收到的数据是否正确，其余均无法判断，并不是可靠传输

> [!tip]
> **无差错接受**：接收端数据链路层接受的帧，都能认为在传输过程中没有产生差错
> 
> **可靠传输**：发送端发送什么，接收端就收到什么

## 点对点协议 PPP

针对点对点的链路，目前使用最广泛的是 *PPP* 协议

### PPP协议特点

作用域：**用户计算机** 和 *ISP* 通信时所使用的数据链路层协议

*PPP* 协议需要满足以下 **需求**：
1. **简单**：对数据链路层的帧，不需要纠错、序号、流量控制，简单作为首要要求；收到帧进行 *CRC* 检验，无差错则接收，反之丢弃
2. **封装成帧**：必须规定特殊的字符作为帧定界符，使接收端从收到的比特流中准确找出帧的开始和结束位置
3. **透明性**：必须保证数据传输的透明性，要能解决碰巧出现和帧定界符一样的比特组合的问题
4. **多种网络层协议**：必须能够在同一条物理链路上同时支持多种网络层协议的运行，如IP等；在局域网和路由器上同样如此
5. **多种类型链路**：必须能够在多种链路上运行
6. **差错检验**：必须能够对接收端收到的帧进行检测，并立即丢弃有差错的帧
7. **检测连接状态**：必须能够自动检测链路是否处于正常工作状态
8. **最大传送单元**：必须对每一种类型的点对点链路设置 *MTU* 的标准默认值；促进各种实现之间的互操作性，若高层协议发送的分组数据部分超过 *MTU* 值，则丢弃并返回差错
9. **网络层地址协商**：必须提供一种机制使通信的两个网络层的实体能够通过协商知道或能够配置彼此的网络层地址
10. **数据压缩协商**：必须提供方法来协商使用数据压缩算法

*TCP/IP* 协议族中，可靠传输由 *TCP* 协议负责。*PPP* 不负责纠错等。*PPP* 只支持点对点的链路通信，且只支持全双工链路。
*PPP* **的特点**：不支持多点线路，只支持点对点的链路通信，只支持全双工链路

*PPP* 协议的 **组成**
- 将 *IP* 数据报封装到串行链路的方法；*PPP* 支持 **异步链路**，也支持面向比特的 **同步链路**；*IP* 数据报在 *PPP* 帧中数据部分，收到 *MTU* 限制
- 用来建立、配置和测试链路连接的链路控制协议 *LCP*
- 网络控制协议 *NCP*，其中每一个协议支持不同的网络层协议

### PPP协议的帧格式

*PPP* 帧格式如下图所示

![ppp帧格式](images/ppp协议帧格式.png)

*PPP* 的首部和尾部分别为 **4个字段** 和 **2个字段**。

- 首部的第一个字段和尾部的第二个字段都是 **标志字段** *F*，规定为 *0x7E*，它标志着一个帧的开始或结束。两个连续的帧之间只需要一个 F，如果连续出现两个标志字段，表示这是一个空帧，应该丢弃。
- 首部的第二个和第三个字段 目前都没有实际含义。第四个字段是 2 字节的协议字段，它表明了信息部分的数据类型（可能是IP数据报也可能是其他类型的数据）。**尾部的第一个字段是帧检验序列** *FCS*。

> [!tip]
> **字节填充**
> 
> *PPP* 使用异步传输时使用了字节填充，转义符为 *0x7D*。
> 
> **零比特填充**
> *PPP* 协议用在 *SONET/SDH* 链路上时使用同步传输，此时采用 **零比特填充方法** 来实现透明传输。
> 
> 零比特填充的方法：当信息字段中出现 5 个连续的 1，立即填入一个 0，这样信息字段中就不会出现 6 个连续的 1（*PPP* 的帧定界符中有 6 个连续的 1）。

### PPP 协议的工作状态

*PPP* **链路从建立到释放的全过程**：用户拨号接入 *ISP* 后，就建立了从用户到 *ISP* 的物理连接。这时用户向 *ISP* 发送一系列的链路控制协议 *LCP* 分组，以便建立 *LCP* 连接。然后网络控制协议 *NCP* 给新接入的用户电脑分配一个临时的 *IP* 地址。等用户通信完毕后，*NCP* 释放网络层连接，收回分配的 *IP* 地址，然后 *LCP* 释放数据链路层连接，最后释放物理层连接。

> *PPP* **链路的状态变化**：

**链路静止**——**链路建立**——**鉴别**——**网络层协议**——**链路打开**——**链路终止**——**链路静止**。

- **链路静止**：*PPP* 链路的其实和终止状态都是链路静止状态。
- **链路建立**：当个人电脑当建立了到路由器的物理层连接后，*PPP* 进入链路建立状态，目的是建立链路层的 *LCP* 连接。
  - 通过 **发送** *LCP* **的配置请求帧**（是一个 *PPP* 帧，协议字段为 *LCP* 对应的代码，信息字段包括特定的配置请求）来协商配置选项，链路的另一端可以回复配置确认帧、配置否认帧或配置拒绝帧。
- **鉴别**：若鉴别身份失败就转到链路终止状态，若成功就进入网络层协议状态
- **网络层协议**：这时 *PPP* 链路的两端的网络控制协议 *NCP* 根据网络层的不同协议互相交换网络层特定的网络控制分组。*PPP* 链路的两端可以运行不同的网络层协议。
- **链路打开**：此时链路的两个 *PPP* 端点可以彼此发送分组。
  - 数据传输结束后链路的一端发送终止请求 LCP 帧请求终止链路连接，收到终止确认后转到链路终止状态。
- **链路终止**。终止后进入链路静止状态。
- **链路静止**

![ppp协议状态图](images/ppp协议状态图.png)

